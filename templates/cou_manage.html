{% extends "base_layout.html" %}
{% load static %}

{% block title %}Course Management{% endblock %}

{% block content %}


    <div class="management-header">
        <!-- <h1 class="page-title">Course Management</h1> -->
        <button class="btn-clear-filters" id="clearFilters">Clear All Filters</button>
    </div>

    <!-- Filter Form - REPLACES your filter-box -->
    <!-- Filter Form -->
<div class="filters-card">
    <h2 class="filters-title">Filter Courses</h2>
    <form method="get" id="filterForm" class="filters-grid">
        {% csrf_token %}
        
        <!-- ROW 1: 3 filters -->
        <div class="filter-group">
            <label for="year">Year</label>
            <select name="year" id="year">
                <option value="">All Years</option>
                {% for year in years %}
                    <option value="{{ year }}" {% if request.GET.year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="prog_type">Programme Type</label>
            <select name="prog_type" id="prog_type">
                <option value="">All Types</option>
                {% for type in prog_types %}
                    <option value="{{ type }}" {% if request.GET.prog_type == type|stringformat:"s" %}selected{% endif %}>{{ type|upper }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="course_category">Programme Category</label>
            <select name="course_category" id="course_category">
                <option value="">All Categories</option>
                {% for cat in course_categories %}
                    <option value="{{ cat }}" {% if request.GET.course_category == cat|stringformat:"s" %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- ROW 2: 3 filters -->
        <div class="filter-group">
            <label for="prog_code">Programme Name</label>
            <select name="prog_code" id="prog_code">
                <option value="">All Programmes</option>
                {% for prog in prog_codes %}
                    <option value="{{ prog }}" {% if request.GET.prog_code == prog|stringformat:"s" %}selected{% endif %}>{{ prog }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="part">Part/Branch</label>
            <select name="part" id="part">
                <option value="">All Parts</option>
                {% for p in parts %}
                    <option value="{{ p }}" {% if request.GET.part == p|stringformat:"s" %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="sem">Semester</label>
            <select name="sem" id="sem">
                <option value="">All Semesters</option>
                {% for semester in semesters %}
                    <option value="{{ semester }}" {% if request.GET.sem == semester|stringformat:"s" %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- ROW 3: Course Code and Title filters -->
        <div class="filter-group">
            <label for="course_code">Course Code</label>
            <select name="course_code" id="course_code">
                <option value="">All Codes</option>
                {% for code in course_codes %}
                    <option value="{{ code }}" {% if request.GET.course_code == code|stringformat:"s" %}selected{% endif %}>{{ code }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="course_title">Course Title</label>
            <select name="course_title" id="course_title">
                <option value="">All Titles</option>
                {% for title in course_titles %}
                    <option value="{{ title }}" {% if request.GET.course_title == title|stringformat:"s" %}selected{% endif %}>{{ title }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <!-- Empty for layout purposes -->
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn-apply">Apply Filters</button>
        </div>
    </form>
</div>


    <!-- Results Table -->
    {% if courses %}
    <div class="results-section">
        <div class="results-header">
            <h3 class="results-title">{{ courses|length }} Courses Found</h3>
        </div>
        
        <div class="table-responsive">
            <table class="management-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Programme Type</th>
                        <th>Programme Category</th>
                        <th>Programme Name</th>
                        <th>Branch</th>
                        <th>Semester</th>
                        <th>Course Code with Title</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>{{ course.year|default:"â€”" }}</td>
                        <td>{{ course.prog_type|default:"â€”" }}</td>
                        <td>{{ course.course_category|default:"â€”" }}</td>
                        <td>{{ course.prog_code|default:"â€”" }}</td>
                        <td>{{ course.part|default:"â€”" }}</td>
                        <td>{{ course.sem|default:"â€”" }}</td>
                        <td>
                            <strong>{{ course.course_code|default:"â€”" }}</strong><br>
                            <small>{{ course.course_title|default:"â€”" }}</small>
                        </td>
                        <!-- REPLACE your current View button -->
<td>
    {% if course.course_code %}
        <a href="{% url 'view_course_pdf' course.course_code %}" class="view-btn">
            View
        </a>
    {% else %}
        <button class="view-btn" disabled>View</button>
    {% endif %}
</td>


                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="no-results">
        <div class="no-results-icon">ðŸ“š</div>
        <h3>No Courses Found</h3>
        <p>Apply filters or add courses from <a href="{% url 'upload_center' %}">Upload Center</a></p>
    </div>
    {% endif %}
</div>

<!-- PDF Viewer Modal -->
<div class="pdf-modal" id="pdfModal">
    <div class="pdf-modal-content">
        <div class="pdf-header">
            <h3 id="pdfTitle">Loading Course Content...</h3>
            <button class="close-pdf" id="closePdf">&times;</button>
        </div>
        <div class="pdf-container">
            <iframe id="pdfFrame" src="" width="100%" height="600px"></iframe>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ONLY open PDF when user clicks View button
    document.querySelectorAll('.view-pdf-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const courseCode = this.getAttribute('data-course-code');
            document.getElementById('pdfTitle').textContent = `Course: ${courseCode}`;
            document.getElementById('pdfFrame').src = `/view_course_pdf/${courseCode}/`;
            document.getElementById('pdfModal').style.display = 'flex';
        });
    });
    
    // Close modal
    document.getElementById('closePdf').addEventListener('click', function() {
        document.getElementById('pdfModal').style.display = 'none';
        document.getElementById('pdfFrame').src = '';
    });
    
    // Close on outside click
    document.getElementById('pdfModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
            document.getElementById('pdfFrame').src = '';
        }
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all filter select elements
    const filterSelects = {
        'year': document.getElementById('year'),
        'prog_type': document.getElementById('prog_type'),
        'course_category': document.getElementById('course_category'),
        'prog_code': document.getElementById('prog_code'),
        'part': document.getElementById('part'),
        'sem': document.getElementById('sem'),
        'course_code': document.getElementById('course_code'),
        'course_title': document.getElementById('course_title')
    };
    
    // Store original options as data attributes
    for (let [key, select] of Object.entries(filterSelects)) {
        if (select) {
            let options = [];
            for (let option of select.options) {
                if (option.value) {
                    options.push({value: option.value, text: option.text});
                }
            }
            select.dataset.allOptions = JSON.stringify(options);
        }
    }
    
    // Function to get current filter values
    function getCurrentFilters() {
        let filters = {};
        for (let [key, select] of Object.entries(filterSelects)) {
            if (select && select.value) {
                filters[key] = select.value;
            }
        }
        return filters;
    }
    
    // Function to update a single dropdown
    function updateDropdown(select, options, currentValue) {
        if (!select) return;
        
        // Clear current options (keep the "All" option)
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Add new options
        options.forEach(optValue => {
            let option = document.createElement('option');
            option.value = optValue;
            option.text = optValue;
            if (currentValue && currentValue === optValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }
    
    // Function to update all dropdowns based on current filters
    function updateFilters(changedFilter = null) {
        let filters = getCurrentFilters();
        
        // Build URL with current filters
        let url = '/get-filter-options/?' + new URLSearchParams(filters);
        
        // Fetch new options
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Update each dropdown with new options
                for (let [key, select] of Object.entries(filterSelects)) {
                    if (select && key !== changedFilter) { // Don't update the filter that just changed
                        updateDropdown(select, data[key] || [], filters[key]);
                    }
                }
            })
            .catch(error => console.error('Error:', error));
    }
    
    // Add event listeners to all filters
    for (let [key, select] of Object.entries(filterSelects)) {
        if (select) {
            select.addEventListener('change', function() {
                updateFilters(key);
            });
        }
    }
    
    // Clear filters button
    const clearBtn = document.getElementById('clearFilters');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            // Reset all selects to "All" option
            for (let [key, select] of Object.entries(filterSelects)) {
                if (select) {
                    select.value = '';
                    
                    // Restore all original options
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    if (select.dataset.allOptions) {
                        let allOptions = JSON.parse(select.dataset.allOptions);
                        allOptions.forEach(opt => {
                            let option = document.createElement('option');
                            option.value = opt.value;
                            option.text = opt.text;
                            select.appendChild(option);
                        });
                    }
                }
            }
            
            // Submit the form to clear all filters
            document.getElementById('filterForm').submit();
        });
    }
});
</script>
{% endblock %}
